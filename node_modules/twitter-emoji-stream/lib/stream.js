var Twitter = require('twitter');

var emoji_re = new RegExp("[\u2600-\u27BF]|\uD83C[\uDDE6-\uDDFA\uDF00-\uDFFF]|\uD83D[\uDC00-\uDE4F\uDE80-\uDEF3]|\uD83E[\uDD10-\uDDC0]", 'g');

function twitterEmojiStream(credentials, track, callback){
	if(!credentials || !track || !callback)
		callback("Required parameter not supplied")
			
	try {
		var client = new Twitter({
			consumer_key: credentials.consumer_key,
			consumer_secret: credentials.consumer_secret,
			access_token_key: credentials.access_token_key,
			access_token_secret: credentials.access_token_secret
		});
	}
	catch(err){
		callback(err);
	}
	
	if( Array.isArray(track) )
		track = track.join();	
	

	
	client.stream('statuses/filter', {track: track}, function(stream, err) {
		if(err) callback(err);
		stream.on('data', function(tweet) {
			if(emoji_re.test(tweet.text)){
				// See if the user is referring to another tweet
				console.log(tweet.text.match(emoji_re));
				
				if(tweet.quoted_status){
					console.log("QUOTED STATUS");
					quoted_tweet = tweet.quoted_status.text; 
					quoted_tweeter = tweet.quoted_status.screen_name;
				} else {
					quoted_tweet="";
					quoted_tweeter="";
				}
				callback(null, {id: tweet.id_str, author: tweet.user.screen_name, tweet: tweet.text, quoted_tweet: quoted_tweet, quoted_tweeter: quoted_tweeter, emojis: tweet.text.match(emoji_re)});
			}			
		});
	});
	
}


module.exports = twitterEmojiStream;