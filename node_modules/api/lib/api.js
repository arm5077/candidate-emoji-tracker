var express = require("express");
var app = express();

// Endpoint to get full emoji list per candidate
app.get("/list", function(request, response){	
	pool.getConnection(function(err, connection){
		if(err) throw err;
		connection.query('SELECT candidate, emoji, COUNT(emoji) as count FROM emoji_counts GROUP BY candidate, emoji ORDER BY candidate ASC, count DESC', function(err, rows){ 
			if(err) throw err; 
		
			var candidates = [];
		
			rows.forEach(function(row){
				var index = candidates.map(function(d){ return d.name }).indexOf(row.candidate);
				if( index == -1 ){
					candidates.push({ name: row.candidate, emojis: [] });
					index = candidates.length - 1;
				}
				candidates[index].emojis.push({ emoji: row.emoji, count: row.count })
			
			});
			connection.release();
			response.status(200).json(candidates);
		});
	});
});

// Get latest emoji
app.get("/latest", function(request, response){	
	pool.getConnection(function(err, connection){
		connection.query('SELECT id, candidate, emoji, link FROM emoji_counts ORDER BY id DESC LIMIT 10', function(err, rows){ 
			connection.release();
			response.status(200).json(rows);
		});
	});
});

module.exports = app;