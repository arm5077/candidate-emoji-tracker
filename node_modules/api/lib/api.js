var express = require("express");
var app = express();
var apicache = require('apicache').options({ debug: true }).middleware;


// Endpoint to get full emoji list per candidate
app.get("/list", function(request, response){	
	pool.getConnection(function(err, connection){
		if(err) throw err;
		connection.query('SELECT candidate, emoji, COUNT(emoji) as count, link FROM (SELECT * FROM emoji_counts ORDER BY id DESC) as emoji_counts GROUP BY candidate, emoji ORDER BY candidate ASC, count DESC', function(err, rows){ 
			if(err) throw err; 
			connection.release();
			
			var candidates = [];
		
			rows.forEach(function(row){
				var index = candidates.map(function(d){ return d.name }).indexOf(row.candidate);
				if( index == -1 ){
					candidates.push({ name: row.candidate, total: 0, emojis: [] });
					index = candidates.length - 1;
				}
				candidates[index].emojis.push({ emoji: row.emoji, count: row.count, link: row.link })
				candidates[index].total += row.count;
			});
			
			// Sort by most popular candidates
			candidates.sort(function(a,b){
				return b.total - a.total;
			})
			
			response.status(200).json(candidates);
		});
	});
});

// Get latest emoji
app.get("/latest", apicache('30 seconds'), function(request, response){	
	pool.getConnection(function(err, connection){
		connection.query('SELECT id, candidate, emoji, link FROM emoji_counts ORDER BY id DESC LIMIT 10', function(err, rows){ 
			connection.release();
			response.status(200).json(rows);
		});
	});
});

module.exports = app;