var express = require("express");
var app = express();
var apicache = require('apicache').options({ debug: true }).middleware;


// Endpoint to get full emoji list per candidate
app.get("/list", apicache('5 minutes'), function(request, response){	
	pool.getConnection(function(err, connection){
		if(err) throw err;
		connection.query('SELECT emoji_counts.candidate, emoji_counts.emoji, COUNT(emoji_counts.emoji) as count, links.link FROM emoji_counts join (select candidate, emoji, link from (select * from emoji_counts order by id desc) as emoji_counts group by candidate, emoji) as links on links.candidate = emoji_counts.candidate and links.emoji = emoji_counts.emoji GROUP BY emoji_counts.candidate, emoji_counts.emoji ORDER BY candidate desc, count DESC', function(err, rows){ 
			if(err) throw err; 
			connection.release();
			
			var candidates = [];
		
			rows.forEach(function(row){
				var index = candidates.map(function(d){ return d.name }).indexOf(row.candidate);
				if( index == -1 ){
					candidates.push({ name: row.candidate, total: 0, emojis: [] });
					index = candidates.length - 1;
				}
				candidates[index].emojis.push({ emoji: row.emoji, count: row.count, link: row.link })
				candidates[index].total += row.count;
			});
			
			// Sort by most popular candidates
			candidates.sort(function(a,b){
				return b.total - a.total;
			})
			
			response.status(200).json(candidates);
		});
	});
});

// Get latest emoji
app.get("/latest", apicache('30 seconds'), function(request, response){	
	pool.getConnection(function(err, connection){
		connection.query('SELECT id, candidate, emoji, link FROM emoji_counts ORDER BY id DESC LIMIT 10', function(err, rows){ 
			connection.release();
			response.status(200).json(rows);
		});
	});
});

module.exports = app;